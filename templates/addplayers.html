{% extends "base.html" %}

{% block title %}Dream11 Fantasy Builder{% endblock %}

{% block extra_css %}
.role-section h5 {
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 10px;
  padding-bottom: 5px;
}
.player-card {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 12px;
  transition: transform 0.2s;
}
.player-card:hover {
  transform: scale(1.02);
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
}
.btn-float {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999;
}
{% endblock %}

{% block content %}
<div class="container-fluid py-2">

  <!-- Compact Navbar-Style Controls -->
  <nav class="navbar navbar-expand-lg mb-3" style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 text-white">
        <i class="fas fa-users"></i> Player Management
      </span>
      
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" onclick="toggleAddPlayer()">
          <i class="fas fa-plus"></i> Add Player
        </button>
        <button class="btn btn-outline-warning btn-sm" onclick="toggleAnalysis()">
          <i class="fas fa-chart-bar"></i> Analysis
        </button>
        <button class="btn btn-outline-info btn-sm" onclick="toggleQuickActions()">
          <i class="fas fa-tools"></i> Actions
        </button>
      </div>
    </div>
  </nav>

  <!-- Success/Error Messages -->
  {% if success_message %}
  <div class="alert alert-success alert-dismissible fade show py-2" role="alert">
    <strong>✅</strong> {{ success_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}
  
  {% if error_message %}
  <div class="alert alert-danger alert-dismissible fade show py-2" role="alert">
    <strong>❌</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <!-- Compact Analysis Card -->
  <div id="analysisCard" class="d-none mb-3">
    <div class="row g-2">
      <div class="col-md-6">
        <div class="card bg-dark text-white border-info" style="border-radius: 8px;">
          <div class="card-body py-2">
            <h6 class="card-title mb-2"><i class="fas fa-chart-line text-info"></i> Team A Analysis</h6>
            <div class="row text-sm">
              <div class="col-6"><small><strong>Total:</strong> {{ summary.TeamA_Total }}%</small></div>
              <div class="col-6"><small><strong>BAT:</strong> {{ summary.TeamA_BAT }}%</small></div>
              <div class="col-6"><small><strong>BOWL:</strong> {{ summary.TeamA_BOWL }}%</small></div>
              <div class="col-6"><small><strong>ALL:</strong> {{ summary.TeamA_ALL }}%</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-dark text-white border-warning" style="border-radius: 8px;">
          <div class="card-body py-2">
            <h6 class="card-title mb-2"><i class="fas fa-chart-line text-warning"></i> Team B Analysis</h6>
            <div class="row text-sm">
              <div class="col-6"><small><strong>Total:</strong> {{ summary.TeamB_Total }}%</small></div>
              <div class="col-6"><small><strong>BAT:</strong> {{ summary.TeamB_BAT }}%</small></div>
              <div class="col-6"><small><strong>BOWL:</strong> {{ summary.TeamB_BOWL }}%</small></div>
              <div class="col-6"><small><strong>ALL:</strong> {{ summary.TeamB_ALL }}%</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Add Player Form -->
  <div id="addPlayerForm" class="d-none mb-3">
    <div class="card bg-dark text-white border-success" style="border-radius: 8px;">
      <div class="card-body py-2">
        <form action="/addplayer" method="post" class="row g-2 align-items-end">
          <input type="hidden" name="matchid" value="{{matchid}}">
          <div class="col-md-2">
            <label class="form-label text-white small mb-1">Player Name</label>
            <input name="playername" class="form-control form-control-sm" placeholder="Enter name" required>
          </div>
          <div class="col-md-2">
            <label class="form-label text-white small mb-1">Team</label>
            <select name="teamname" class="form-select form-select-sm" required>
              {% for team in teams %}<option>{{team.team1}}</option><option>{{team.team2}}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label text-white small mb-1">Role</label>
            <select name="role" class="form-select form-select-sm" required>
              <option>BAT</option><option>BOWL</option><option>ALL</option><option>WK</option>
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label text-white small mb-1">%</label>
            <input name="percentage" class="form-control form-control-sm" placeholder="0.0" type="number" step="0.1" required>
          </div>
          <div class="col-md-2">
            <label class="form-label text-white small mb-1">Match Role</label>
            <select name="matchrole" class="form-select form-select-sm">
              <option>OB1</option><option>OB2</option><option>1D</option><option>2D</option>
              <option>F</option><option>PS</option><option>OBO1</option><option>OBO2</option>
              <option>DBO1</option><option>DBO2</option><option>BBO</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success btn-sm w-100">
              <i class="fas fa-plus"></i> Add Player
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Compact Quick Actions -->
  <div id="quickActions" class="d-none mb-3">
    <div class="card bg-dark text-white border-info" style="border-radius: 8px;">
      <div class="card-body py-2">
        <div class="row g-2">
          <div class="col-md-3">
            <a href="/bulkRemovePlayers?matchid={{matchid}}" class="btn btn-danger btn-sm w-100">
              <i class="fas fa-trash-alt"></i> Bulk Remove
            </a>
          </div>
          <div class="col-md-3">
            <a href="/bulkUpdateMatchRoles?matchid={{matchid}}" class="btn btn-warning btn-sm w-100">
              <i class="fas fa-users-cog"></i> Update Roles
            </a>
          </div>

          <div class="col-md-3">
            <a href="/player_alternatives_map/{{matchid}}" class="btn btn-warning btn-sm w-100">
              <i class="fas fa-exchange-alt"></i> Alternatives Map
            </a>
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#generateTeamsModal">
              <i class="fas fa-cogs"></i> Generate
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Tabs -->
  <ul class="nav nav-tabs mb-2" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="card-tab" data-bs-toggle="tab" data-bs-target="#cardView" type="button" role="tab">Card View</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#tableView" type="button" role="tab">Table View</button>
    </li>
  </ul>



  <!-- Tab Content -->
  <div class="tab-content" id="viewTabsContent">
    <!-- Card View -->
    <div class="tab-pane fade show active" id="cardView" role="tabpanel">
      <div class="row">
        {% for role in ["BAT", "BOWL", "AL", "WK"] %}
        <div class="col-md-3">
          <div class="glass-panel role-section">
            <h5 class="text-center">{{ role }} {% set count = players|selectattr("role", "equalto", role)|list|length %}<span class="badge bg-info ms-2">{{ count }}</span></h5>
            {% for player in players if player.role == role %}
            <div class="player-card">
              <strong>{{ player.playername }}</strong><br>
              <small>{{ player.teamname }} | %: {{ player.percentage }} | MR: {{ player.matchrole }}</small>
              <form action="/removePlayer" method="post" class="mt-1">
                <input type="hidden" name="playername" value="{{ player.playername }}">
                <input type="hidden" name="matchid" value="{{ player.matchid }}">
                <button type="submit" class="btn btn-sm btn-outline-danger mt-1">Remove</button>
              </form>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Table View -->
    <div class="tab-pane fade" id="tableView" role="tabpanel">
      <div class="glass-panel">
        <h5 class="mb-3 text-white">All Players Table</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-sm table-striped bg-white text-dark">
            <thead class="table-light">
              <tr>
                <th>Player Name</th>
                <th>Team</th>
                <th>Role</th>
                <th>Percentage</th>
                <th>Match Role</th>
                <th style="width: 200px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for player in players %}
              <tr>
                <td>{{ player.playername }}</td>
                <td>{{ player.teamname }}</td>
                <td>{{ player.role }}</td>
                <td>{{ player.percentage }}</td>
                <td>{{ player.matchrole }}</td>
                <td>
                  <a href="/updatePlayerRole?matchid={{ player.matchid }}&player_name={{ player.playername }}" 
                     class="btn btn-sm btn-warning me-2">
                    <i class="fas fa-edit"></i> Update Match Role
                  </a>
                  <form action="/removePlayer" method="post" class="d-inline">
                    <input type="hidden" name="playername" value="{{ player.playername }}">
                    <input type="hidden" name="matchid" value="{{ player.matchid }}">
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toggle Scripts -->
<script>
  function toggleAnalysis() {
    const card = document.getElementById('analysisCard');
    card.classList.toggle('d-none');
  }
  
  function toggleAddPlayer() {
    const form = document.getElementById('addPlayerForm');
    form.classList.toggle('d-none');
  }
  
  function toggleQuickActions() {
    const actions = document.getElementById('quickActions');
    actions.classList.toggle('d-none');
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Generate Teams Modal -->
<div class="modal fade" id="generateTeamsModal" tabindex="-1" aria-labelledby="generateTeamsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: rgba(15, 32, 39, 0.95); border: 1px solid rgba(255,255,255,0.2);">
      <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
        <h5 class="modal-title text-white" id="generateTeamsModalLabel">
          <i class="fas fa-cogs"></i> Generate Teams
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form action="/generateTeams" method="post" id="generateTeamsForm">
        <div class="modal-body">
          <input type="hidden" name="matchid" value="{{matchid}}">
          
          <!-- Strategy Selection -->
          <div class="mb-4">
            <h6 class="text-white mb-3">
              <i class="fas fa-bullseye text-warning"></i> Team Strategy
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="wininning" value="Batting" id="wininning" checked>
                  <label class="form-check-label text-white" for="battingStrategy">
                    <i class="fas fa-baseball-ball text-success me-2"></i>Batting First
                  </label>
                  <small class="text-muted d-block">Optimized for setting a target</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="wininning" value="Chaseing" id="wininning">
                  <label class="form-check-label text-white" for="chasingStrategy">
                    <i class="fas fa-running text-info me-2"></i>Chaseing
                  </label>
                  <small class="text-muted d-block">Optimized for chaseing a target</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Fixed Players Selection -->
          <div class="mb-4">
            <h6 class="text-white mb-3">
              <i class="fas fa-lock text-warning"></i> Fixed Players (Optional)
            </h6>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="d-flex gap-2 mb-2">
                  <button type="button" class="btn btn-sm btn-outline-info" onclick="selectTopPlayers(3)">
                    Top 3
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-info" onclick="selectTopPlayers(5)">
                    Top 5
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectByRole('BAT')">
                    All BAT
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectByRole('BOWL')">
                    All BOWL
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllFixed()">
                    Clear All
                  </button>
                  <span class="text-info ms-auto">
                    Selected: <span id="fixedPlayerCount" class="text-info">0</span>/5
                  </span>
                </div>
              </div>
            </div>
            
            <div class="row" style="max-height: 200px; overflow-y: auto;">
              {% for player in players %}
              <div class="col-md-6 col-lg-4">
                <div class="form-check mb-2">
                  <input class="form-check-input fixed-player-checkbox" type="checkbox" 
                         name="fixed_players" value="{{ player.playername }}" 
                         id="fixed_{{ loop.index }}">
                  <label class="form-check-label text-white small" for="fixed_{{ loop.index }}">
                    <strong>{{ player.playername }}</strong><br>
                    <small class="text-muted">{{ player.teamname }} | {{ player.role }} | {{ player.percentage }}%</small>
                  </label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Team Generation Options -->
          <div class="mb-4">
            <h6 class="text-white mb-3">
              <i class="fas fa-sliders-h text-primary"></i> Generation Options
            </h6>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="enforce_top13" value="1" id="enforceTop13" checked>
                  <label class="form-check-label text-white" for="enforceTop13">
                    Enforce Top 13 Rule (7-8 players)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="ensure_diversity" value="1" id="ensureDiversity" checked>
                  <label class="form-check-label text-white" for="ensureDiversity">
                    Ensure Team Diversity (4+ different players)
                  </label>
                </div>
              </div>
            </div>
          </div>
          

          
          <!-- Summary -->
          <div class="alert alert-info" style="background: rgba(13, 202, 240, 0.1); border: 1px solid rgba(13, 202, 240, 0.3);">
            <h6 class="text-info mb-2">
              <i class="fas fa-chart-line"></i> Generation Summary
            </h6>
            <ul class="mb-0 text-white small" id="generationSummary">
              <li>Teams to generate: <strong>1 per template</strong></li>
              <li>Fixed players: <strong><span id="summaryFixedCount">0</span></strong></li>
              <li>Variable slots: <strong><span id="summaryVariableSlots">11</span></strong></li>
              <li>Top 13 validation: <strong>Enabled</strong></li>
              <li>Team diversity: <strong>Enabled</strong></li>
            </ul>
          </div>
        </div>
        
        <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.2);">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-play"></i> Generate Teams
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Team generation form logic
document.addEventListener('DOMContentLoaded', function() {
  // Fixed player selection logic
  const checkboxes = document.querySelectorAll('.fixed-player-checkbox');
  const countDisplay = document.getElementById('fixedPlayerCount');
  const summaryCount = document.getElementById('summaryFixedCount');
  const summarySlots = document.getElementById('summaryVariableSlots');
  const maxFixed = 5;
  
  function updateFixedPlayerCounts() {
    const checkedCount = document.querySelectorAll('.fixed-player-checkbox:checked').length;
    countDisplay.textContent = checkedCount;
    summaryCount.textContent = checkedCount;
    summarySlots.textContent = 11 - checkedCount;
    
    // Disable unchecked boxes if max reached
    checkboxes.forEach(checkbox => {
      if (!checkbox.checked && checkedCount >= maxFixed) {
        checkbox.disabled = true;
      } else {
        checkbox.disabled = false;
      }
    });
    
    // Update count color
    if (checkedCount > maxFixed) {
      countDisplay.className = 'text-danger';
    } else if (checkedCount > 0) {
      countDisplay.className = 'text-success';
    } else {
      countDisplay.className = 'text-info';
    }
  }
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateFixedPlayerCounts);
  });
  
  // Form validation
  document.getElementById('generateTeamsForm').addEventListener('submit', function(e) {
    const checkedCount = document.querySelectorAll('.fixed-player-checkbox:checked').length;
    if (checkedCount > maxFixed) {
      e.preventDefault();
      alert(`Please select maximum ${maxFixed} fixed players. Currently selected: ${checkedCount}`);
      return false;
    }
  });
  

  
  // Helper functions
  window.selectTopPlayers = function(count) {
    clearAllFixed();
    const checkboxes = document.querySelectorAll('.fixed-player-checkbox');
    let selected = 0;
    checkboxes.forEach(checkbox => {
      if (selected < count && selected < maxFixed) {
        checkbox.checked = true;
        selected++;
      }
    });
    updateFixedPlayerCounts();
  };
  
  window.selectByRole = function(role) {
    clearAllFixed();
    const labels = document.querySelectorAll('.form-check-label');
    let selected = 0;
    labels.forEach(label => {
      if (selected < maxFixed && label.textContent.includes(role)) {
        const checkbox = label.previousElementSibling;
        if (checkbox && checkbox.type === 'checkbox' && checkbox.classList.contains('fixed-player-checkbox')) {
          checkbox.checked = true;
          selected++;
        }
      }
    });
    updateFixedPlayerCounts();
  };
  
  window.clearAllFixed = function() {
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
      checkbox.disabled = false;
    });
    updateFixedPlayerCounts();
  };
  
  // Initialize
  updateFixedPlayerCounts();
});
</script>
{% endblock %}

{% block extra_js %}
{% endblock %}
